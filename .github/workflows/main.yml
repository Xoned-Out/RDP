# File: .github/workflows/personal-rdp.yml
name: Personal RDP Workstation

on:
  workflow_dispatch:

jobs:
  deploy-rdp:
    runs-on: windows-latest
    timeout-minutes: 43200  # 30 days max

    steps:
      - name: Configure RDP for Personal Use
        run: |
          # Enable RDP with relaxed security for personal access
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          
          # Personal firewall rule
          netsh advfirewall firewall add rule name="Personal RDP" dir=in action=allow protocol=TCP localport=3389
          
          Restart-Service TermService -Force

      - name: Create Personal User Account
        run: |
          $password = "YourSecurePassword123!"  # CHANGE THIS
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          New-LocalUser -Name "MyRDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "MyRDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "MyRDPUser"
          
          echo "RDP_CREDS=MyRDPUser / $password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile "$env:TEMP\tailscale.msi"
          msiexec /i "$env:TEMP\tailscale.msi" /quiet /norestart
          Remove-Item "$env:TEMP\tailscale.msi" -Force

      - name: Connect Tailscale
        run: |
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=my-personal-rdp
          
          # Get Tailscale IP
          $tsIP = ""
          $attempts = 0
          while (-not $tsIP -and $attempts -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep 3
              $attempts++
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Enable Public Access via Tailscale Funnel
        run: |
          # Make RDP accessible through Tailscale Funnel (public internet)
          & "$env:ProgramFiles\Tailscale\tailscale.exe" funnel --bg 3389
          
          # Get Funnel URL
          $funnelInfo = & "$env:ProgramFiles\Tailscale\tailscale.exe" funnel status
          echo "FUNNEL_INFO=$funnelInfo" >> $env:GITHUB_ENV

      - name: Keep Alive
        run: |
          Write-Host "=== YOUR PERSONAL RDP WORKSTATION ==="
          Write-Host "Connect via:"
          Write-Host "1. Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "2. Username: MyRDPUser"
          Write-Host "3. Password: YourSecurePassword123!"
          Write-Host "4. Funnel URL: $env:FUNNEL_INFO"
          Write-Host "================================"
          Write-Host ""
          Write-Host "This runner will stay active for 30 days or until manually cancelled."
          Write-Host "Use this for personal projects, testing, or any legitimate work."
          
          # Keep-alive loop
          while ($true) {
              Write-Host "[$(Get-Date)] RDP active - Status OK"
              Start-Sleep 60
          }
