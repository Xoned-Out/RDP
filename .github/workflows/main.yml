name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Check System
        run: |
          echo "Starting RDP setup on Ubuntu..."
          uname -a
          lsb_release -a

      - name: Update System
        run: |
          sudo apt update
          sudo apt upgrade -y

      - name: Install Basic Dependencies
        run: |
          sudo apt install -y curl wget net-tools dbus-x11

      - name: Install XFCE Desktop
        run: |
          echo "Installing XFCE desktop..."
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies
          echo "XFCE installation completed"

      - name: Install Additional GUI Components
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xorg
          sudo DEBIAN_FRONTEND=noninteractive apt install -y firefox
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4-terminal
          sudo DEBIAN_FRONTEND=noninteractive apt install -y thunar
          sudo DEBIAN_FRONTEND=noninteractive apt install -y mousepad

      - name: Install and Configure xRDP
        run: |
          echo "Installing xRDP..."
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xrdp
          
          echo "Configuring xRDP..."
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo systemctl status xrdp --no-pager || echo "xRDP service check completed"
          
          echo "Configuring xRDP session..."
          echo 'startxfce4' | sudo tee /etc/xrdp/startwm.sh
          sudo chmod +x /etc/xrdp/startwm.sh
          
          # Add user to ssl-cert group
          sudo usermod -aG ssl-cert xrdp || echo "SSL cert group modification completed"

      - name: Configure Firewall
        run: |
          echo "Configuring firewall..."
          sudo apt install -y ufw
          sudo ufw allow 3389/tcp
          sudo ufw --force enable || echo "UFW configuration completed"

      - name: Create RDP User
        run: |
          echo "Creating RDP user..."
          PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 10)
          USERNAME="rdpuser"
          
          # Check if user exists
          if id "$USERNAME" &>/dev/null; then
            echo "User $USERNAME already exists, deleting..."
            sudo userdel -r $USERNAME || true
          fi
          
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          
          echo "RDP_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          echo "User $USERNAME created successfully"

      - name: Install Tailscale
        run: |
          echo "Installing Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh || echo "Tailscale installation attempt completed"

      - name: Establish Tailscale Connection
        run: |
          echo "Setting up Tailscale connection..."
          if [ -z "${{ secrets.TAILSCALE_AUTH_KEY }}" ]; then
            echo "ERROR: TAILSCALE_AUTH_KEY secret is not set!"
            exit 1
          fi
          
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname=github-rdp-$GITHUB_RUN_ID
          
          echo "Waiting for Tailscale IP..."
          sleep 15
          
          TS_IP=$(tailscale ip -4 2>/dev/null || echo "")
          if [ -z "$TS_IP" ]; then
            echo "Warning: Could not get Tailscale IPv4, trying IPv6..."
            TS_IP=$(tailscale ip -6 2>/dev/null || echo "")
          fi
          
          if [ -z "$TS_IP" ]; then
            echo "ERROR: Failed to get Tailscale IP address"
            echo "Tailscale status:"
            sudo tailscale status || true
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "Tailscale connected with IP: $TS_IP"

      - name: Verify Services
        run: |
          echo "=== Service Status ==="
          echo "xRDP status:"
          sudo systemctl is-active xrdp && echo "xRDP: ACTIVE" || echo "xRDP: INACTIVE"
          
          echo "Tailscale status:"
          sudo tailscale status || echo "Tailscale status check failed"
          
          echo "Network status:"
          sudo netstat -tlnp | grep :3389 && echo "RDP port: LISTENING" || echo "RDP port: NOT LISTENING"

      - name: Display Connection Information
        run: |
          echo ""
          echo "=========================================="
          echo "üéØ RDP CONNECTION INFORMATION"
          echo "=========================================="
          echo "IP Address: $TAILSCALE_IP"
          echo "Username: $RDP_USERNAME"
          echo "Password: $RDP_PASSWORD"
          echo "Port: 3389"
          echo ""
          echo "üîß Connection Methods:"
          echo "Windows: Use Remote Desktop Connection"
          echo "Linux: xfreerdp /v:$TAILSCALE_IP /u:$RDP_USERNAME /p:$RDP_PASSWORD"
          echo "macOS: Microsoft Remote Desktop app"
          echo ""
          echo "‚ö†Ô∏è  Important:"
          echo "- This session will auto-terminate after 60 minutes"
          echo "- Use Ctrl+C in workflow to stop early"
          echo "- Ensure your Tailscale client is connected"
          echo "=========================================="
          echo ""

      - name: Keep Session Alive
        run: |
          echo "üîÑ RDP session is now active..."
          echo "Keeping the session alive for 60 minutes..."
          
          counter=0
          while [ $counter -lt 60 ]; do
            remaining=$((60 - counter))
            echo "[$(date)] Session active - $remaining minutes remaining"
            
            # Basic service health checks
            if ! systemctl is-active xrdp > /dev/null; then
              echo "‚ö†Ô∏è  xRDP service stopped, attempting restart..."
              sudo systemctl restart xrdp || true
            fi
            
            counter=$((counter + 1))
            sleep 60
          done
          
          echo "‚è∞ Session time limit reached - stopping"
