name: Stable RDP Workstation
on:
  workflow_dispatch:
    inputs:
      runtime_hours:
        description: 'Hours to run'
        required: false
        default: '24'
        type: choice
        options:
          - '24'
          - '72'
          - '168'

jobs:
  stable-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ fromJSON(github.event.inputs.runtime_hours == '168' && '10080' || github.event.inputs.runtime_hours == '72' && '4320' || '1440') }}

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable RDP with proper settings
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          reg add "HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 1 /f  # Keep some security
          
          # Firewall rule
          netsh advfirewall firewall delete rule name="GitHub-RDP" 2>$null
          netsh advfirewall firewall add rule name="GitHub-RDP" dir=in action=allow protocol=TCP localport=3389 enable=yes
          
          Restart-Service TermService -Force

      - name: Create RDP User
        run: |
          # Simple password generator
          $password = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 16 | ForEach-Object {[char]$_})
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
          
          echo "USER=RDPUser" >> $env:GITHUB_ENV
          echo "PASS=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale
        run: |
          # Download and install Tailscale
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installer
          Start-Process msiexec.exe -Wait -NoNewWindow -ArgumentList @("/i", "`"$installer`"", "/quiet", "/norestart")
          Remove-Item $installer

      - name: Setup Tailscale Connection
        run: |
          # Start Tailscale service
          Start-Service Tailscale -ErrorAction SilentlyContinue
          Start-Sleep 5
          
          # Connect with persistent settings
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=rdp-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          
          # Get IP with retry
          $ip = $null
          for ($i=0; $i -lt 10; $i++) {
              $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if ($ip) { break }
              Start-Sleep 3
          }
          
          if (-not $ip) {
              # Try status command
              $status = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json 2>$null | ConvertFrom-Json
              $ip = $status.Self.TailscaleIPs[0]
          }
          
          echo "TS_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "Tailscale IP: $ip"

      - name: Enable Funnel (Public Access)
        run: |
          # Enable funnel for public access
          & "$env:ProgramFiles\Tailscale\tailscale.exe" funnel --bg 3389 2>$null
          $funnel = & "$env:ProgramFiles\Tailscale\tailscale.exe" funnel status 2>$null
          echo "FUNNEL=$funnel" >> $env:GITHUB_ENV

      - name: Display Connection Info
        run: |
          Write-Host "`n" + ("="*50)
          Write-Host "RDP WORKSTATION READY"
          Write-Host "="*50
          Write-Host "Connect using any RDP client (mstsc.exe, Remmina, etc.)"
          Write-Host ""
          Write-Host "Method 1 - Direct Tailscale:"
          Write-Host "  Address: $env:TS_IP"
          Write-Host "  Username: $env:USER"
          Write-Host "  Password: $env:PASS"
          Write-Host ""
          Write-Host "Method 2 - Public Access (if enabled):"
          if ($env:FUNNEL -and $env:FUNNEL -notmatch "No funnel") {
              $lines = $env:FUNNEL -split "`n"
              foreach ($line in $lines) {
                  if ($line -match "https://") {
                      Write-Host "  URL: $($line.Trim())"
                  }
              }
          } else {
              Write-Host "  (Funnel not enabled or failed)"
          }
          Write-Host ""
          Write-Host "Runtime: ${{ github.event.inputs.runtime_hours }} hours"
          Write-Host "Cancel workflow to stop"
          Write-Host "="*50

      - name: Keep Alive with Stable Connection
        run: |
          # Function to check and fix Tailscale
          function Repair-Tailscale {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Checking Tailscale..."
              
              # Check if Tailscale service is running
              $service = Get-Service Tailscale -ErrorAction SilentlyContinue
              if (-not $service -or $service.Status -ne "Running") {
                  Write-Host "  Starting Tailscale service..."
                  Start-Service Tailscale -ErrorAction SilentlyContinue
                  Start-Sleep 3
              }
              
              # Check connection
              $status = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json 2>$null
              if (-not $status -or $status -match "not running") {
                  Write-Host "  Reconnecting Tailscale..."
                  & "$env:ProgramFiles\Tailscale\tailscale.exe" up --reset --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} 2>$null
                  Start-Sleep 5
              }
              
              # Get current IP
              $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if ($ip) {
                  Write-Host "  Connected: $ip"
                  return $true, $ip
              } else {
                  Write-Host "  Not connected"
                  return $false, $null
              }
          }
          
          # Main keep-alive loop
          $startTime = Get-Date
          $hours = [int]"${{ github.event.inputs.runtime_hours || '24' }}"
          $endTime = $startTime.AddHours($hours)
          $lastStatus = Get-Date
          $consecutiveFailures = 0
          
          Write-Host "`nStarting keep-alive monitoring..."
          
          while ((Get-Date) -lt $endTime) {
              $now = Get-Date
              $elapsed = $now - $startTime
              $remaining = $endTime - $now
              
              # Repair Tailscale every 2 minutes or if too many failures
              if (($now - $lastStatus).TotalMinutes -ge 2 -or $consecutiveFailures -gt 2) {
                  $connected, $currentIp = Repair-Tailscale
                  
                  if ($connected) {
                      $consecutiveFailures = 0
                      # Update environment if IP changed
                      if ($currentIp -and $currentIp -ne $env:TS_IP) {
                          Write-Host "  IP changed to: $currentIp"
                          $env:TS_IP = $currentIp
                      }
                  } else {
                      $consecutiveFailures++
                      if ($consecutiveFailures -gt 3) {
                          Write-Host "  Critical: Tailscale failed multiple times. Trying full restart..."
                          Stop-Service Tailscale -Force -ErrorAction SilentlyContinue
                          Start-Sleep 2
                          Start-Service Tailscale -ErrorAction SilentlyContinue
                          Start-Sleep 5
                          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --reset --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} 2>$null
                      }
                  }
                  
                  $lastStatus = $now
              }
              
              # Status update every 5 minutes
              if ([math]::Floor($elapsed.TotalMinutes) % 5 -eq 0) {
                  Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Status: OK | IP: $env:TS_IP | Elapsed: $($elapsed.ToString('hh\:mm')) | Remaining: $($remaining.ToString('hh\:mm'))"
                  Start-Sleep 60  # Skip a minute to avoid duplicate messages
              }
              
              Start-Sleep 30
          }
          
          Write-Host "Runtime complete. Exiting..."
