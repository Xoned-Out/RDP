name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update System and Install Kali Desktop
        run: |
          sudo apt update
          sudo apt upgrade -y
          sudo apt install -y kali-desktop-xfce xrdp xorg dbus-x11
          sudo apt install -y firefox-esr gnome-terminal net-tools

      - name: Configure xRDP
        run: |
          # Configure xRDP to use XFCE
          echo "xfce4-session" > ~/.xsession
          sudo cp ~/.xsession /etc/skel/
          
          # Configure xRDP settings
          sudo sed -i 's/port=3389/port=3389/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
          
          # Enable xRDP service
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Configure Firewall
        run: |
          sudo ufw allow 3389
          sudo ufw --force enable

      - name: Create RDP User with Secure Password
        run: |
          # Generate secure password
          PASSWORD=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9!@#$%^&*' | head -c 16)
          USERNAME="kali-rdp-user"
          
          # Create user
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          
          # Add to necessary groups
          sudo usermod -aG sudo $USERNAME
          sudo usermod -aG audio $USERNAME
          sudo usermod -aG video $USERNAME
          
          echo "RDP_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          
          # Verify user creation
          if ! id "$USERNAME" &>/dev/null; then
              echo "‚ùå User creation failed"
              exit 1
          fi
          echo "‚úÖ User $USERNAME created successfully"

      - name: Install Tailscale
        run: |
          # Install Tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          sudo apt update
          sudo apt install -y tailscale

      - name: Establish Tailscale Connection
        run: |
          # Start Tailscale with auth key from secrets
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname=github-kali-$GITHUB_RUN_ID
          
          # Wait for IP assignment
          echo "‚è≥ Waiting for Tailscale IP..."
          TS_IP=""
          for i in {1..15}; do
              TS_IP=$(sudo tailscale ip -4 2>/dev/null || echo "")
              if [ -n "$TS_IP" ]; then
                  echo "‚úÖ Tailscale IP: $TS_IP"
                  break
              fi
              echo "Attempt $i/15: Waiting for Tailscale IP..."
              sleep 5
          done
          
          if [ -z "$TS_IP" ]; then
              echo "‚ùå Failed to get Tailscale IP"
              sudo tailscale status
              exit 1
          fi
          
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Verify RDP Accessibility
        run: |
          echo "üîç Testing RDP connectivity..."
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Install netcat if not present
          sudo apt install -y netcat
          
          # Test RDP port
          if nc -z -w 10 $TAILSCALE_IP 3389; then
              echo "‚úÖ RDP port 3389 is accessible"
          else
              echo "‚ùå RDP port 3389 is not accessible"
              echo "Checking xRDP status..."
              sudo systemctl status xrdp
              exit 1
          fi

      - name: Display Connection Information
        run: |
          echo ""
          echo "=========================================="
          echo "üéØ KALI LINUX RDP ACCESS INFORMATION"
          echo "=========================================="
          echo "IP Address: $TAILSCALE_IP"
          echo "Username: $RDP_USERNAME"
          echo "Password: $RDP_PASSWORD"
          echo "Port: 3389"
          echo ""
          echo "üìù Connect using:"
          echo "   xfreerdp /v:$TAILSCALE_IP /u:$RDP_USERNAME /p:$RDP_PASSWORD"
          echo "   or Windows Remote Desktop Connection"
          echo ""
          echo "‚è∞ This runner will stay active for 60 minutes"
          echo "=========================================="
          echo ""

      - name: Keep Runner Active
        run: |
          # Install dependencies for desktop functionality
          sudo apt install -y xfce4-terminal mousepad thunar
          
          echo "üñ•Ô∏è  RDP session is ready and active"
          echo "‚è∞ Keeping runner alive for 60 minutes..."
          
          # Countdown timer (60 minutes)
          for i in {1..60}; do
              minutes_remaining=$((60 - i))
              echo "[$(date)] RDP Active - $minutes_remaining minutes remaining - Use 'Cancel workflow' to stop"
              sleep 60
          done
          echo "‚è∞ Time limit reached, stopping RDP session"
