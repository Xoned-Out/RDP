name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update System and Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y curl wget net-tools dbus-x11

      - name: Install Desktop Environment
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 \
            xfce4-session \
            xfce4-goodies \
            xorg \
            xrdp \
            firefox \
            xfce4-terminal \
            thunar \
            mousepad \
            gedit \
            network-manager \
            policykit-1-gnome \
            xfce4-panel \
            xfdesktop4 \
            xfwm4

      - name: Configure D-Bus and XFCE
        run: |
          sudo systemctl enable dbus
          sudo systemctl start dbus
          mkdir -p ~/.config/xfce4/xfconf/xfce-perchannel-xml
          sudo mkdir -p /etc/xdg/xfce4

      - name: Configure xRDP Properly
        run: |
          sudo systemctl stop xrdp
          
          # Create startwm.sh using echo commands to avoid YAML multi-line issues
          sudo bash -c 'cat > /etc/xrdp/startwm.sh << "ENDFILE"
#!/bin/sh
if [ -r /etc/default/locale ]; then
  . /etc/default/locale
  export LANG LANGUAGE
fi

export XDG_SESSION_TYPE=x11
export XDG_DATA_DIRS=/usr/share/xfce4:/usr/share/xubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop
export XDG_CONFIG_DIRS=/etc/xdg/xfce4:/etc/xdg

if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
  eval $(dbus-launch --sh-syntax --exit-with-session)
fi

startxfce4
ENDFILE'
          
          sudo chmod +x /etc/xrdp/startwm.sh
          sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
          sudo usermod -aG ssl-cert xrdp
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          sudo systemctl status xrdp --no-pager

      - name: Configure Firewall
        run: |
          sudo apt install -y ufw
          sudo ufw allow 3389
          sudo ufw --force enable
          sudo ufw status

      - name: Create RDP User with Proper Setup
        run: |
          PASSWORD=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9!@#$%^&*' | head -c 16)
          USERNAME="rdpuser"
          
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo,audio,video $USERNAME
          
          sudo -u $USERNAME mkdir -p /home/$USERNAME/.config/xfce4/xfconf/xfce-perchannel-xml
          sudo -u $USERNAME mkdir -p /home/$USERNAME/.local/share/xfce4
          
          # Create .xsession file using echo
          sudo -u $USERNAME bash -c 'cat > /home/$USERNAME/.xsession << "ENDFILE"
#!/bin/sh
export XDG_SESSION_TYPE=x11
export XDG_DATA_DIRS=/usr/share/xfce4:/usr/share/xubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop
export XDG_CONFIG_DIRS=/etc/xdg/xfce4:/etc/xdg

if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
  eval $(dbus-launch --sh-syntax --exit-with-session)
fi

exec startxfce4
ENDFILE'
          
          sudo chmod +x /home/$USERNAME/.xsession
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME/
          
          echo "RDP_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          echo "User $USERNAME created"

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname=ubuntu-rdp-$GITHUB_RUN_ID
          
          TS_IP=""
          for i in {1..15}; do
            TS_IP=$(tailscale ip -4 2>/dev/null || echo "")
            if [ -n "$TS_IP" ]; then
              echo "Tailscale IP: $TS_IP"
              break
            fi
            sleep 3
          done
          
          if [ -z "$TS_IP" ]; then
            echo "No Tailscale IP"
            exit 1
          fi
          
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Final Service Check
        run: |
          sudo systemctl status xrdp --no-pager
          sudo tailscale status
          sudo netstat -tlnp | grep :3389 && echo "RDP port listening"

      - name: Display Connection Info
        run: |
          echo "=========================================="
          echo "UBUNTU XFCE RDP ACCESS"
          echo "=========================================="
          echo "IP: $TAILSCALE_IP"
          echo "User: $RDP_USERNAME" 
          echo "Pass: $RDP_PASSWORD"
          echo "Port: 3389"
          echo "=========================================="

      - name: Keep Runner Active
        run: |
          for i in {1..60}; do
            minutes_left=$((60 - i))
            echo "RDP Active - $minutes_left minutes remaining"
            sleep 60
          done
