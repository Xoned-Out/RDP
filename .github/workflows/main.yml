name: Kali Tools on Ubuntu

on:
  workflow_dispatch:

jobs:
  kali-tools:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install SSH and Basic Tools
        run: |
          sudo apt update
          sudo apt install -y \
            openssh-server \
            nmap \
            curl \
            wget \
            git \
            python3 \
            python3-pip \
            net-tools \
            iputils-ping \
            dnsutils \
            whois \
            john \
            hydra \
            sqlmap \
            nikto \
            gobuster \
            exploitdb \
            tshark

      - name: Install Metasploit Standalone
        run: |
          # Download and install Metasploit standalone
          curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall
          chmod +x msfinstall
          sudo ./msfinstall

      - name: Configure SSH
        run: |
          sudo systemctl enable ssh
          sudo systemctl start ssh
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Create User
        run: |
          PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 10)
          USERNAME="kali"
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          echo "SSH_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "SSH_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname=kali-tools-$GITHUB_RUN_ID
          sleep 10
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Display Info
        run: |
          echo "=========================================="
          echo "üîê PENETRATION TESTING SSH"
          echo "=========================================="
          echo "IP: $TAILSCALE_IP"
          echo "Username: $SSH_USERNAME"
          echo "Password: $SSH_PASSWORD"
          echo "Port: 22"
          echo ""
          echo "üîß Connect: ssh $SSH_USERNAME@$TAILSCALE_IP"
          echo ""
          echo "üõ†Ô∏è  Tools Available:"
          echo "‚Ä¢ msfconsole (Metasploit)"
          echo "‚Ä¢ nmap, sqlmap, john, hydra"
          echo "‚Ä¢ nikto, gobuster, exploitdb"
          echo "‚Ä¢ wireshark (tshark)"
          echo "=========================================="

      - name: Keep Alive
        run: |
          for i in {1..360}; do
            echo "SSH Active - $((360-i)) minutes left"
            sleep 60
          done
