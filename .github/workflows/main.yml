name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: kali-latest
    timeout-minutes: 3600

    steps:
      - name: Install and Configure xRDP
        run: |
          # Update system and install xRDP
          sudo apt update
          sudo apt install -y xrdp xfce4 xfce4-goodies
          
          # Configure xRDP to use XFCE
          echo "xfce4-session" > ~/.xsession
          sudo cp ~/.xsession /etc/skel/
          
          # Configure xRDP to use X11
          sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/port=3389/port=3389/g' /etc/xrdp/xrdp.ini
          
          # Enable and start xRDP service
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Configure Firewall for RDP
        run: |
          # Allow RDP port through firewall
          sudo ufw allow 3389/tcp
          sudo ufw --force enable

      - name: Create RDP User with Secure Password
        run: |
          # Generate secure password
          PASSWORD=$(openssl rand -base64 32 | tr -d '/+' | cut -c1-16)
          PASSWORD="${PASSWORD}$(openssl rand -base64 32 | tr -dc '!@#$%^&*' | cut -c1-4)"
          
          # Create user and set password
          sudo useradd -m -s /bin/bash rdpuser
          echo "rdpuser:${PASSWORD}" | sudo chpasswd
          
          # Add user to sudo and other necessary groups
          sudo usermod -aG sudo rdpuser
          sudo usermod -aG audio rdpuser
          sudo usermod -aG video rdpuser
          
          echo "RDP_CREDS=User: rdpuser | Password: $PASSWORD" >> $GITHUB_ENV
          
          # Verify user creation
          if ! id "rdpuser" &>/dev/null; then
              echo "User creation failed"
              exit 1
          fi

      - name: Install Tailscale
        run: |
          # Add Tailscale repository and install
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          sudo apt update
          sudo apt install -y tailscale

      - name: Establish Tailscale Connection
        run: |
          # Start Tailscale and connect
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-kali-runner-$GITHUB_RUN_ID
          
          # Wait for Tailscale IP assignment
          TS_IP=""
          for i in {1..10}; do
              TS_IP=$(tailscale ip -4)
              if [ -n "$TS_IP" ]; then
                  break
              fi
              sleep 5
          done
          
          if [ -z "$TS_IP" ]; then
              echo "Tailscale IP not assigned. Exiting."
              exit 1
          fi
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Verify RDP Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Test RDP port connectivity
          if ! nc -z -w 5 $TAILSCALE_IP 3389; then
              echo "TCP connection to RDP port 3389 failed"
              exit 1
          fi
          echo "TCP connectivity successful!"

      - name: Install Additional Desktop Utilities
        run: |
          # Install useful desktop applications
          sudo apt install -y firefox-esr file-manager-packages \
                           gnome-terminal net-tools

      - name: Maintain Connection
        run: |
          echo -e "\n=== RDP ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: rdpuser"
          echo "Password: $(echo $RDP_CREDS | cut -d'|' -f2 | cut -d':' -f2-)"
          echo "==================\n"
          
          # Keep runner active
          while true; do
              echo "[$(date)] RDP Active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
