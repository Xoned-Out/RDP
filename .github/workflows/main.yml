name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update System and Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y curl wget net-tools

      - name: Install Desktop Environment
        run: |
          # Install XFCE desktop and required packages
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xfce4 \
            xfce4-goodies \
            xorg \
            dbus-x11 \
            xrdp \
            firefox \
            xfce4-terminal \
            thunar \
            mousepad \
            gedit \
            network-manager

      - name: Configure xRDP
        run: |
          # Create xsession file for XFCE
          mkdir -p ~/.local/share/xfce4
          echo "xfce4-session" > ~/.xsession
          sudo cp ~/.xsession /etc/skel/
          
          # Configure xrdp
          sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/port=3389/port=3389/g' /etc/xrdp/xrdp.ini
          
          # Add xrdp user to ssl-cert group
          sudo adduser xrdp ssl-cert
          
          # Enable and start xrdp
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          
          echo "xRDP status:"
          sudo systemctl status xrdp --no-pager

      - name: Configure Firewall
        run: |
          sudo apt install -y ufw
          sudo ufw allow 3389
          sudo ufw allow ssh
          sudo ufw --force enable
          echo "Firewall status:"
          sudo ufw status

      - name: Create RDP User
        run: |
          # Generate secure password
          PASSWORD=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9!@#$%^&*' | head -c 16)
          USERNAME="kaliuser"
          
          # Create user
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo,audio,video $USERNAME
          
          # Set up XFCE for user
          sudo -u $USERNAME mkdir -p /home/$USERNAME/.config/xfce4
          sudo -u $USERNAME bash -c "echo 'xfce4-session' > /home/$USERNAME/.xsession"
          
          echo "RDP_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          echo "‚úÖ User $USERNAME created"

      - name: Install Tailscale
        run: |
          # Install Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Verify installation
          tailscale --version || echo "Tailscale installed"

      - name: Establish Tailscale Connection
        run: |
          echo "üîë Setting up Tailscale connection..."
          
          # Start Tailscale
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname=github-ubuntu-rdp-$GITHUB_RUN_ID
          
          # Wait for IP
          TS_IP=""
          for i in {1..15}; do
              TS_IP=$(tailscale ip -4 2>/dev/null || echo "")
              if [ -n "$TS_IP" ]; then
                  echo "‚úÖ Tailscale IP: $TS_IP"
                  break
              fi
              echo "Waiting for IP... ($i/15)"
              sleep 3
          done
          
          if [ -z "$TS_IP" ]; then
              echo "‚ùå No Tailscale IP"
              sudo tailscale status
              exit 1
          fi
          
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Verify Services
        run: |
          echo "üîç Service Status:"
          sudo systemctl status xrdp --no-pager
          sudo tailscale status
          sudo netstat -tlnp | grep :3389 || echo "Setting up RDP port..."

      - name: Display Connection Info
        run: |
          echo ""
          echo "=========================================="
          echo "üñ•Ô∏è  UBUNTU RDP ACCESS"
          echo "=========================================="
          echo "IP: $TAILSCALE_IP"
          echo "User: $RDP_USERNAME"
          echo "Pass: $RDP_PASSWORD"
          echo "Port: 3389"
          echo ""
          echo "Connect with:"
          echo "xfreerdp /v:$TAILSCALE_IP /u:$RDP_USERNAME /p:$RDP_PASSWORD"
          echo "=========================================="
          echo ""

      - name: Keep Alive
        run: |
          echo "üîÑ RDP session active for 60 minutes..."
          for i in {1..60}; do
              echo "[$(date)] Active - $((60-i)) minutes left"
              sleep 60
          done
