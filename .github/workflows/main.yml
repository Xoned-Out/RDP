name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Install xRDP and XFCE
        run: |
          sudo apt update
          sudo apt install -y xrdp xfce4 xfce4-goodies firefox
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          echo "xfce4-session" > ~/.xsession
          sudo ufw allow 3389

      - name: Create User
        run: |
          USER="rdpuser"
          PASS="Password123"
          sudo useradd -m -s /bin/bash $USER
          echo "$USER:$PASS" | sudo chpasswd
          sudo usermod -aG sudo $USER
          echo "RDP_USER=$USER" >> $GITHUB_ENV
          echo "RDP_PASS=$PASS" >> $GITHUB_ENV

      - name: Setup Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}"
          sleep 10
          IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$IP" >> $GITHUB_ENV

      - name: Show Info
        run: |
          echo "RDP Ready: $TAILSCALE_IP:3389"
          echo "User: $RDP_USER"
          echo "Pass: $RDP_PASS"

      - name: Keep Running
        run: |
          while true; do
            echo "RDP Active - $(date)"
            sleep 30
          done
