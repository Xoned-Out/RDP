name: Kali Linux Direct

on:
  workflow_dispatch:

jobs:
  kali-direct:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Kali Packages on Ubuntu
        run: |
          sudo apt update
          
          # Add Kali repositories
          echo 'deb https://http.kali.org/kali kali-rolling main non-free contrib' | sudo tee /etc/apt/sources.list.d/kali.list
          wget 'https://archive.kali.org/archive-key.asc'
          sudo apt-key add archive-key.asc
          
          sudo apt update
          
          # Install Kali tools
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            kali-linux-headless \
            metasploit-framework \
            nmap \
            wireshark \
            john \
            hydra \
            sqlmap \
            nikto \
            gobuster \
            exploitdb \
            openssh-server

      - name: Configure SSH
        run: |
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # Allow root SSH login
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh

      - name: Create SSH User
        run: |
          PASSWORD=$(openssl rand -base64 12)
          USERNAME="kali"
          
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          
          echo "SSH_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "SSH_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname=kali-direct-$GITHUB_RUN_ID
          sleep 10
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Display Connection Info
        run: |
          echo "=========================================="
          echo "üîê KALI LINUX SSH ACCESS"
          echo "=========================================="
          echo "IP: $TAILSCALE_IP"
          echo "Username: $SSH_USERNAME"
          echo "Password: $SSH_PASSWORD"
          echo "Port: 22"
          echo ""
          echo "üîß Connect: ssh $SSH_USERNAME@$TAILSCALE_IP"
          echo ""
          echo "üõ†Ô∏è  Available Tools:"
          echo "msfconsole, nmap, sqlmap, john, hydra, etc."
          echo "=========================================="

      - name: Keep Alive
        run: |
          for i in {1..360}; do
            echo "Kali SSH Active - $((360-i)) minutes left"
            sleep 60
          done
