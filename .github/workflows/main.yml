name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Update System
        run: |
          sudo apt update
          sudo apt upgrade -y

      - name: Install xRDP and XFCE
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt install -y \
            xrdp \
            xfce4 \
            xfce4-goodies \
            xorg \
            dbus-x11 \
            xfce4-terminal \
            firefox \
            thunar \
            mousepad

      - name: Fix xRDP Black Screen Issue
        run: |
          # Stop xrdp service
          sudo systemctl stop xrdp
          
          # Configure xrdp to use Xorg instead of Xvnc
          sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/port=3389/port=3389/g' /etc/xrdp/xrdp.ini
          
          # Create proper session configuration
          sudo tee /etc/xrdp/startwm.sh > /dev/null << 'EOF'
#!/bin/sh
# xrdp X session start script

unset DBUS_SESSION_BUS_ADDRESS
unset XDG_RUNTIME_DIR

if [ -r /etc/default/locale ]; then
  . /etc/default/locale
  export LANG LANGUAGE
fi

# Start XFCE
export XDG_SESSION_DESKTOP=xfce
export XDG_DATA_DIRS=/usr/share/xfce4:/usr/share:/usr/local/share:/usr/share
export XDG_CONFIG_DIRS=/etc/xdg/xfce4:/etc/xdg

exec startxfce4
EOF

          sudo chmod +x /etc/xrdp/startwm.sh

      - name: Configure xRDP Service
        run: |
          # Add xrdp user to ssl-cert group
          sudo usermod -aG ssl-cert xrdp
          
          # Enable and start xrdp
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          
          # Check xrdp status
          sudo systemctl status xrdp

      - name: Configure Firewall
        run: |
          sudo apt install -y ufw
          sudo ufw allow 3389
          sudo ufw --force enable

      - name: Create RDP User
        run: |
          PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c 10)
          USERNAME="rdpuser"
          
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          
          # Set up XFCE for the user
          sudo -u $USERNAME dbus-launch --exit-with-session xfce4-session &
          sleep 5
          sudo pkill -u $USERNAME
          
          echo "RDP_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install and Configure Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname=ubuntu-rdp-$GITHUB_RUN_ID
          sleep 10
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Alternative xRDP Fix
        run: |
          # Additional fixes for black screen
          sudo apt install -y xserver-xorg-core xserver-xorg-video-fbdev
          
          # Create polkit rule to allow user authentication
          sudo tee /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla > /dev/null << 'EOF'
[Allow Colord for All Users]
Identity=unix-user:*
Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
ResultAny=yes
ResultInactive=yes
ResultActive=yes
EOF

      - name: Test xRDP Session
        run: |
          # Test if XFCE session starts properly
          timeout 10s sudo -u rdpuser startxfce4 > /tmp/xfce-test.log 2>&1 || true
          echo "XFCE test completed"

      - name: Display Connection Info
        run: |
          echo "=========================================="
          echo "UBUNTU XFCE RDP - CONNECTION INFO"
          echo "=========================================="
          echo "IP: $TAILSCALE_IP"
          echo "Username: $RDP_USERNAME"
          echo "Password: $RDP_PASSWORD"
          echo "Port: 3389"
          echo ""
          echo "If you get a black screen, try these solutions:"
          echo "1. Wait 30-60 seconds after connecting"
          echo "2. Try connecting multiple times"
          echo "3. Use xfreerdp instead of Windows RDP:"
          echo "   xfreerdp /v:$TAILSCALE_IP /u:$RDP_USERNAME /p:$RDP_PASSWORD +glyph-cache +boards"
          echo "=========================================="

      - name: Keep Alive
        run: |
          for i in {1..60}; do
            echo "RDP Active - $((60-i)) minutes left - IP: $TAILSCALE_IP"
            sleep 60
          done
