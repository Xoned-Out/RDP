name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Update System and Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y curl wget net-tools dbus-x11

      - name: Install Desktop Environment
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-session xfce4-goodies
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xorg xrdp firefox
          sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4-terminal thunar mousepad
          sudo DEBIAN_FRONTEND=noninteractive apt install -y policykit-1-gnome network-manager

      - name: Configure D-Bus and XFCE
        run: |
          sudo systemctl enable dbus
          sudo systemctl start dbus

      - name: Configure xRDP
        run: |
          sudo systemctl stop xrdp
          echo '#!/bin/sh' | sudo tee /etc/xrdp/startwm.sh
          echo 'export XDG_SESSION_TYPE=x11' | sudo tee -a /etc/xrdp/startwm.sh
          echo 'export XDG_DATA_DIRS=/usr/share/xfce4:/usr/share:/usr/local/share:/var/lib/snapd/desktop' | sudo tee -a /etc/xrdp/startwm.sh
          echo 'export XDG_CONFIG_DIRS=/etc/xdg/xfce4:/etc/xdg' | sudo tee -a /etc/xrdp/startwm.sh
          echo 'if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then' | sudo tee -a /etc/xrdp/startwm.sh
          echo '  eval $(dbus-launch --sh-syntax --exit-with-session)' | sudo tee -a /etc/xrdp/startwm.sh
          echo 'fi' | sudo tee -a /etc/xrdp/startwm.sh
          echo 'startxfce4' | sudo tee -a /etc/xrdp/startwm.sh
          sudo chmod +x /etc/xrdp/startwm.sh
          sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
          sudo usermod -aG ssl-cert xrdp
          sudo systemctl enable xrdp
          sudo systemctl start xrdp

      - name: Configure Firewall
        run: |
          sudo apt install -y ufw
          sudo ufw allow 3389
          sudo ufw --force enable

      - name: Create RDP User
        run: |
          PASSWORD=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9' | head -c 12)
          USERNAME="rdpuser"
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          echo "RDP_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          sudo tailscale up --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" --hostname=ubuntu-rdp-$GITHUB_RUN_ID
          sleep 10
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Display Connection Info
        run: |
          echo "=== RDP Connection Details ==="
          echo "IP: $TAILSCALE_IP"
          echo "Username: $RDP_USERNAME"
          echo "Password: $RDP_PASSWORD"
          echo "Port: 3389"
          echo "=============================="

      - name: Keep Runner Active
        run: |
          for i in {1..60}; do
            echo "RDP active - $(expr 60 - $i) minutes remaining"
            sleep 60
          done
